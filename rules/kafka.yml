groups:
  - name: kafka
    rules:
      - alert: Kafka Consumer Lag
        expr: round(sum(avg(sum(kafka_consumergroup_lag{}) by (instance, topic, app_group)) by (topic, app_group)) by (app_group)) > (sum by (app_group) (kafka_incoming_log_per_minute{}) * 5)
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Kafka lag more than 5m * current TPM, current: {{ $value | humanize}}"
      - alert: Kafka Consumer Lag
        expr: round(sum(avg(sum(kafka_consumergroup_lag{}) by (instance, topic, app_group)) by (topic, app_group)) by (app_group)) > (sum by (app_group) (kafka_incoming_log_per_minute{}) * 15)
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Kafka lag more than 15m * current TPM , current: {{ $value | humanize}}"
      - alert: Kafka Server Down
        expr: (count(kafka_brokers{} offset 1d) by (app_group) or vector(0)) - count(kafka_brokers{}) by (app_group) > 0
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Exporter in one of kafka is down (there's probability the kafka itself is down)"
      - alert: Kafka Server Down
        expr: count(kafka_brokers{}) by (app_group) - max(kafka_brokers{}) by (app_group) > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "One or more kafka is down on `{{ $labels.app_group}}`"
      - alert: Kafka Server Down
        expr: avg(kafka_brokers{}) by (app_group) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "All kafka in {{ $labels.app_group}} are down"
      - alert: Kafka Exporter Error
        expr: time() - max_over_time(kafka_consumergroup_current_offset:scraptime[1d]) > 600
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "Kafka exporter in `{{ $labels.app_group }}` can't fetch consumer group lag, instance `{{ $labels.instance}}`"
