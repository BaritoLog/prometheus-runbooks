groups:
  - name: Consul
    rules:
      - alert: Container Down
        expr: consul_health_node_status{check="serfHealth", status="critical"} == 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Component *{{ $labels.node }}* in `critical` state, instance *{{ $labels.instance }}*"
      - alert: Consul Down
        expr: (consul_up == 0) OR (count(consul_up offset 1d) by (app_group, instance) - count(consul_up) by (app_group, instance) > 0)
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Consul is down for *{{ $labels.app_group}}*, instance *{{ $labels.instance }}*"
      - alert: Service Healthcheck Failed
        expr: max(consul_health_node_status{status="warning"}) by (app_group, node, check) == 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Healtcheck failed for *{{ $labels.node }}*, {{ $labels.check }}"
      - alert: Service Healthcheck Failed
        expr: max(consul_health_node_status{status="critical"}) by (app_group, node, check) == 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Healtcheck failed for *{{ $labels.node }}*, {{ $labels.check }}"
